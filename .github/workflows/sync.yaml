name: sync fork
on: 
  workflow_dispatch:
  push:
  #schedule:
  #  - cron: '1 6 * * *'
jobs:     
  sync:
    runs-on: ubuntu-latest
    steps:

    - name: Copy Repository Contents
      uses: actions/checkout@v2
      with:
        fetch-depth: '0'
  
    - name: rebase
      run: |
        git remote add upstream https://github.com/Anaconda-Platform/anaconda-client.git
        git fetch upstream && git checkout master && git merge upstream/master

    - name: push changes
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add -A
        git commit --allow-empty -m'[bot] sync with upstream'
        git push
    - uses: actions/setup-python@v2
      
    - name: get versions
      run: |
        pv=$(curl -s https://pypi.org/pypi/anaconda-cli/json | jq -r .info.version)
        echo "::set-env name=pv::pv"
        gv=$(git describe --abbrev=0)
        echo "::set-env name=gv::gv"
        
    - name: display versions
      run: |
        echo "pypi version: ${pypi_version}"
        echo "local version: ${local_version}"
      env:
        pypi_version: ${{ github.env.pv }}
        local_version: ${{ github.env.gv }}
        
    - name: upload to pypi
      if: github.env.py != github.env.gv
      run: |
        pip3 install wheel twine
        python3 setup.py sdist bdist_wheel
        twine upload --repository pypi dist/*
      env:
        TWINE_USERNAME: ${{ secrets.PYPI_USER }}
        TWINE_PASSWORD: ${{ secrets.PYPI_PASS }}
